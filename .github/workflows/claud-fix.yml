name: Claude Fix
on:
  issue_comment:
    types: [created]

jobs:
  claude-fix:
    if: contains(github.event.comment.body, '@claud-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Claude Fix
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          echo "### ðŸ¤– Claude Fix ìž‘ì—… ì‹œìž‘" > claude_output.txt
          claude -p "ì´ìŠˆ #${ISSUE_NUMBER} (${ISSUE_TITLE})ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì›ì¸ ë¶„ì„ê³¼ ìˆ˜ì •ì„ ì§„í–‰í•˜ê³ , ê²°ê³¼ë¥¼ ë³´ê³ í•´ì¤˜. ê°€ëŠ¥í•˜ë‹¤ë©´ ë¸Œëžœì¹˜ë¥¼ ìƒì„±í•˜ê³  ì»¤ë°‹ê¹Œì§€ ì™„ë£Œí•´ì¤˜." >> claude_output.txt 2>&1

      - name: Post Result to Issue
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë¡œê·¸ íŒŒì¼ ìš”ì•½ (ë„ˆë¬´ ê¸¸ë©´ ìž˜ë¦¼ ë°©ì§€)
          LOG_CONTENT=$(head -c 5000 claude_output.txt)
          echo "#### ðŸ“‹ Claude ì‹¤í–‰ ê²°ê³¼" > comment_body.txt
          echo '```' >> comment_body.txt
          echo "$LOG_CONTENT" >> comment_body.txt
          echo '```' >> comment_body.txt
          echo "" >> comment_body.txt
          echo "ìƒì„¸ ë¡œê·¸: [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> comment_body.txt
          
          gh issue comment ${{ github.event.issue.number }} --body-file comment_body.txt
