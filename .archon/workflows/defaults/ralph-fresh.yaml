name: ralph-fresh
description: |
  PRD implementation loop with FRESH CONTEXT each iteration (stateless).

  INVOKE WITH: "ralph-fresh", "run ralph-fresh", "fresh ralph", "stateless ralph".
  NOT FOR: Generic "run ralph" requests - be explicit about which mode.

  HOW IT WORKS:
  - Each iteration starts with a CLEAN SLATE (no memory)
  - AI re-reads progress.txt, prd.json, prd.md every time
  - Learnings persist via progress.txt file (external memory)

  TRADE-OFFS:
  - Pro: No context window bloat on long loops
  - Pro: Each iteration is independent and predictable
  - Pro: Learnings explicitly captured in progress.txt
  - Con: Must re-read files each iteration (slightly slower)
  - Con: AI doesn't "remember" nuances not written down

  BEST FOR:
  - Long PRDs (7+ stories)
  - Independent tasks that don't need shared context
  - When you want explicit, traceable progress

  REQUIRES: .archon/ralph/{feature}/prd.md and prd.json

provider: claude

loop:
  until: COMPLETE
  max_iterations: 10
  fresh_context: true  # Each iteration starts with clean slate

prompt: |
  # Ralph Agent - Fresh Context Mode

  You are an autonomous coding agent. This is a FRESH session - you have no memory of previous iterations.

  **Your job**: Read the current state, do ONE task, update tracking, exit.

  ## Step 1: DETECT FEATURE DIRECTORY

  **User message**: $USER_MESSAGE

  Find the PRD directory:
  - If user message contains a path (e.g., `.archon/ralph/my-feature`), use it
  - Otherwise, auto-detect:
    ```bash
    find .archon/ralph -name "prd.json" -type f 2>/dev/null | head -1 | xargs dirname
    ```

  Store this path as `{prd-dir}` for all operations below.

  ---

  ## Step 2: LOAD CURRENT STATE

  Read these files to understand where we are:

  ### 2.1 Progress Log (CRITICAL - read first)
  ```
  {prd-dir}/progress.txt
  ```
  This shows:
  - What was done in previous iterations
  - Patterns discovered (## Codebase Patterns section)
  - Gotchas to avoid

  ### 2.2 Story Tracking
  ```
  {prd-dir}/prd.json
  ```
  Check which stories have `passes: true` vs `passes: false`.

  ### 2.3 Full Context
  ```
  {prd-dir}/prd.md
  ```
  Goals, UX requirements, technical patterns to follow.

  ---

  ## Step 3: SELECT NEXT STORY

  Find the **highest priority** story where:
  - `passes: false`
  - All `dependsOn` stories have `passes: true`

  **If ALL stories pass**:
  → Go to Step 7 (PR + COMPLETE)

  **If no eligible stories** (blocked):
  → Report which are blocked and why, then exit

  **If eligible story found**:
  ```
  Working on: [Story ID] - [Story Title]
  Acceptance Criteria:
  - [criterion 1]
  - [criterion 2]
  ```

  ---

  ## Step 4: IMPLEMENT

  Using patterns from prd.md and progress.txt:

  1. Check "## Codebase Patterns" in progress.txt for learnings
  2. Follow technical patterns from prd.md
  3. Implement the ONE selected story
  4. Write tests if required by acceptance criteria

  **Rules**:
  - ONE story only - never do multiple
  - Follow existing patterns exactly
  - Check progress.txt for gotchas

  ---

  ## Step 5: VALIDATE

  ```bash
  bun run type-check && bun run lint && bun test
  ```

  **If fails**: Fix and retry. Never commit broken code.

  ---

  ## Step 6: COMMIT & UPDATE TRACKING

  ### 6.1 Commit
  ```bash
  git add -A
  git commit -m "feat: [Story ID] - [Story Title]"
  ```

  ### 6.2 Update prd.json
  Set `passes: true` for completed story.

  ### 6.3 Update progress.txt

  Append:
  ```
  ## [ISO Date] - [Story ID]: [Title]
  - What was implemented
  - Files changed: [list]
  - **Learnings**:
    - [Any pattern discovered]
    - [Any gotcha encountered]
  ---
  ```

  **If you discovered a reusable pattern**, add it to `## Codebase Patterns` at the TOP of progress.txt. Future iterations will see this!

  ---

  ## Step 7: CHECK COMPLETION

  Re-read `{prd-dir}/prd.json`.

  **If ALL stories have `passes: true`**:

  1. Create PR:
     ```bash
     git push -u origin HEAD
     gh pr create --title "feat: [PRD Name] - All stories implemented" --body "$(cat <<'EOF'
     ## Summary
     All user stories implemented and validated.

     ## Stories Completed
     [List each story ID and title]

     ## Validation
     - Type check: passed
     - Lint: passed
     - Tests: passed
     EOF
     )"
     ```

  2. Output completion signal:
     ```
     <promise>COMPLETE</promise>
     ```

  **If MORE stories remain**:
  End normally. Next iteration will pick up where you left off.

  ---

  ## Key Differences from Standard Ralph

  1. **No memory** - You don't remember previous iterations
  2. **Progress.txt is critical** - It's your only link to past work
  3. **Codebase Patterns section** - Check this FIRST for learnings
  4. **One task per iteration** - Do one thing well, exit clean

  ---

  ## File Reference

  | File | Purpose | Why Critical |
  |------|---------|--------------|
  | `{prd-dir}/progress.txt` | Past iteration history | Your memory substitute |
  | `{prd-dir}/prd.json` | Story pass/fail state | Know what's done |
  | `{prd-dir}/prd.md` | Full requirements | Technical patterns |
  | `CLAUDE.md` | Codebase rules | Project conventions |
